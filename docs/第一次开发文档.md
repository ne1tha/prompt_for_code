
## **知识智能平台 - 开发环境启动文档 (v1.0)**

### **1. 项目概述**

[cite\_start]本项目旨在构建一个基于混合RAG架构的知识智能平台 [cite: 1]。当前的首要任务是搭建一个稳定、高效且易于管理的本地开发环境，为后续的核心功能（如知识库摄取、RAG查询等）开发奠定坚实的基础。

经过本次的配置与调试，我们已经成功搭建了这样一个环境。

### **2. 当前项目结构与功用**

项目根目录当前包含以下核心部分：

  * **`/app`**: **后端应用目录**

      * [cite\_start]**`main.py`**: 这是项目的核心后端应用，使用 **FastAPI** 框架编写 [cite: 91]。它目前包含以下功能：
          * 在启动时自动检测并连接到 Qdrant 数据库，具备连接重试能力，增强了启动的稳定性。
          * 提供基础的 API 端点（如 `/` 和 `/health`），用于验证服务是否正常运行。
          * 在首次成功连接数据库后，会自动创建一个名为 `test_collection` 的测试集合，用于验证数据库的可用性。

  * **`/qdrant_storage` (已弃用，现由Docker管理)**:

      * 最初用于持久化 Qdrant 数据的本地文件夹。由于在 Windows 上存在文件系统兼容性问题，我们已改用 Docker 托管数据卷。

  * **`docker-compose.yml`**: **容器编排文件**

      * [cite\_start]该文件定义了项目所需的所有外部服务，目前主要是 **Qdrant 向量数据库** [cite: 91]。
      * [cite\_start]**功用**: 它允许开发者使用简单的命令（如 `docker-compose up`）来一键启动、停止和管理 Qdrant 服务，极大地简化了数据库的部署 [cite: 98]。
      * **关键配置**:
          * `image: qdrant/qdrant`: 指定使用官方的 Qdrant 镜像。
          * `volumes: - qdrant_data:/qdrant/storage`: 使用 **Docker 托管数据卷 (Managed Volume)** 来持久化数据，解决了跨平台文件系统的兼容性问题，性能更佳。
          * `restart: always`: 确保 Docker 容器在电脑重启或意外关闭后能自动重启。

  * **`requirements.txt` / `requirements_for_windows.txt`**: **Python 依赖清单**

      * 该文件精确列出了项目运行所需的所有 Python 库及其版本。
      * **功用**: 确保所有开发者（包括未来的您自己）都能创建出完全一致的虚拟环境，避免了“在我电脑上能跑”的问题。
      * **核心依赖**: `fastapi[all]`, `sqlalchemy`, `qdrant-client`, `llama-index`, `fastembed`。

  * **`Makefile`**: **跨平台自动化任务脚本**

      * 这是项目的**推荐启动方式**，尤其适用于 Linux, macOS, 以及 Windows 上的 Git Bash/WSL 环境。
      * **功用**: 将所有复杂的启动步骤（创建虚拟环境、安装依赖、启动数据库、运行应用）封装成了一个简单的命令 `make run`，实现了真正的“一键启动”。

  * **`set-up.ps1` / `run.ps1` / `stop-dev.ps1`**: **Windows PowerShell 启动脚本**

      * 这是为 Windows 原生 PowerShell 环境提供的便捷启动和停止工具，作为 `Makefile` 在 Windows 上的备用方案。

  * **PowerShell Profile 自定义命令 (`set-proxy`, `clear-proxy`)**:

      * 这是为您个人开发环境定制的便捷工具，通过修改 PowerShell 的配置文件，让您可以用简单的自定义命令来快速启用或禁用终端的代理设置。

### **3. 如何使用当前的应用**

对于一位刚接触这个项目的开发者，只需按照以下步骤即可将整个应用运行起来。

#### **推荐方式 (使用 Makefile - 跨平台)**

1.  **环境要求**:

      * 确保已安装 Docker Desktop 并正在运行。
      * 确保已安装 Python 3.10+。
      * 确保已安装 `make` 工具 (Linux/macOS 自带, Windows 上可通过 Git Bash 或 WSL 获取)。

2.  **启动流程**:

      * 打开一个终端 (在 Windows 上推荐使用 **Git Bash** 或 **WSL**)。
      * 进入项目根目录。
      * 运行以下**唯一**的命令：
        ```bash
        make run
        ```

3.  **发生了什么**:

      * 脚本会自动检查并创建 `venv` 虚拟环境。
      * 自动读取 `requirements.txt` 并安装所有 Python 依赖。
      * 自动在后台启动 Qdrant 数据库容器。
      * 自动激活虚拟环境并启动 FastAPI 应用。

4.  **停止服务**:

      * 在服务器运行的终端按 `Ctrl+C` 停止应用。
      * 然后运行 `make stop` 来关闭并清理数据库容器。

#### **备用方式 (使用 PowerShell 脚本 - 仅限 Windows)**

1.  **环境要求**:

      * 确保 Docker Desktop 已启动。
      * 确保 PowerShell 的执行策略已设置为允许运行本地脚本。

2.  **启动流程**:

      * 打开一个 PowerShell 终端。
      * 进入项目根目录。
      * 运行 `.\start-dev.ps1`。

3.  **停止服务**:

      * 在服务器运行的终端按 `Ctrl+C`。
      * 运行 `.\stop-dev.ps1`。

### **4. 本次对话对项目的关键改动总结**

[cite\_start]在本次对话中，我们从一份企划书 [cite: 1] 出发，共同完成了一系列关键的准备工作，将一个概念性的项目落地为了一个可运行的、健壮的开发框架。主要成果包括：

1.  **环境搭建与初始化**: 我们成功安装了所有必要的 Python 库，并使用 Docker 启动了 Qdrant 向量数据库。

2.  **核心问题排查与解决**:

      * **Docker 文件系统问题**: 解决了在 Windows 上因文件系统不兼容导致 Qdrant 启动失败的问题，最终方案是采用 **Docker 托管数据卷**。
      * **网络代理问题**: 深入排查并解决了因系统代理设置导致 Python 应用无法连接到外部网络（下载模型）和本地服务（连接 Qdrant）的复杂问题，最终通过配置环境变量 (`HTTP_PROXY`, `NO_PROXY`) 成功解决。

3.  **开发工作流自动化**:

      * 我们没有止步于手动敲命令，而是将所有启动、停止、安装的流程封装成了自动化的脚本。
      * 最终产出了一个高度专业且跨平台兼容的 **`Makefile`**，实现了 `make run` 一键启动，极大地提升了开发效率和项目的可维护性。

4.  **代码健壮性提升**:

      * 我们优化了 `app/main.py` 的代码，为其增加了数据库连接的**自动重试逻辑**，使得应用在启动时能够更从容地等待数据库就绪，避免了因启动时序问题导致的崩溃。

通过以上工作，项目已经拥有了一个非常扎实的起点。